<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.makeu.up.notice.service.NoticeMapper">
	<select id="NoticeList" resultType="co.makeu.up.notice.service.NoticeVO" parameterType="co.makeu.up.notice.service.NoticeVO">	
		SELECT * FROM(
            select ROWNUM RN, w.* from(
                select rownum noticeNo, q.* from
                    (SELECT NT_NO,WR_DATE,TTL,CONTENT,HITS,LT_NO,FILE_NO,MOD_DATE, COUNT(*) OVER() AS COUNT
                    FROM NOTICE 
                    where NT_ST_CODE = 'B01'
                    AND LT_NO = #{ltNo}
                    AND (TTL LIKE '%'||#{ttlSearchKey}||'%'
                    AND CONTENT LIKE '%'||#{contentSearchKey}||'%')
                    ORDER BY NT_NO) q
                order by noticeNo desc) w
			WHERE ROWNUM <![CDATA[<=]]> 10*(#{page}))
		WHERE RN <![CDATA[>]]> (#{page}-1)*10
	</select>
  
	<select id="NoticeListCnt" parameterType="Integer" resultType="Integer">
		SELECT COUNT(*) FROM NOTICE
		WHERE LT_NO = #{ltNo}
		AND NT_ST_CODE = 'B01'
	</select>
	
	<select id="NoticeSelect" resultType="co.makeu.up.notice.service.NoticeVO" parameterType="co.makeu.up.notice.service.NoticeVO">
		SELECT N.* FROM 
		NOTICE N LEFT OUTER JOIN DETA_FILE F
		ON N.FILE_NO = F.FILE_NO
		WHERE NT_NO = #{ntNo}
	</select>
	
	<update id="updateHits" parameterType="Integer">
		UPDATE NOTICE
		SET HITS = NVL(#{hits},0) + 1
		WHERE NT_NO = #{ntNo}
	</update>
	<insert id="insertNotice" parameterType="co.makeu.up.notice.service.NoticeVO">
		<selectKey keyProperty="ntNo" order="BEFORE" resultType="int">
			SELECT NVL(MAX(NT_NO), 0)+1 FROM NOTICE
		</selectKey>
		INSERT INTO NOTICE(NT_NO, WR_DATE, TTL, CONTENT, HITS, LT_NO, FILE_NO, NT_ST_CODE)
		VALUES(#{ntNo}, SYSDATE, #{ttl}, #{content}, 0, #{ltNo}, null, 'B01')
	</insert>
	<delete id="deleteNotice" parameterType="co.makeu.up.notice.service.NoticeVO">
		DELETE FROM NOTICE
		WHERE NT_NO = #{ntNo}
	</delete>
	<select id="noticeFiles" parameterType="Integer" resultType="co.makeu.up.files.service.FilesVO">
		SELECT F.*,D.FILE_PATH,D.PHY_PATH FROM FILES F JOIN DETA_FILE D
        ON F.FILE_NO = D.FILE_NO
        WHERE F.FILE_NO = #{ltNo}
	</select>
	<select id="adminNoticeList" parameterType="co.makeu.up.notice.service.NoticeVO" resultType="co.makeu.up.notice.service.NoticeVO">
	SELECT * FROM (SELECT ROWNUM RN, NT_NO,TTL,WR_DATE,HITS, COUNT(*) OVER() COUNT
	FROM NOTICE
	WHERE LT_NO = #{ltNo}
	<if test="ttl != null and !ttl.equals('')">
	AND TTL LIKE '%'||#{ttl}||'%'
	</if>
	<if test="content != null and !content.equals('')">
	AND CONTENT LIKE '%'||#{content}||'%'
	</if>
	<if test="startDate != null and !startDate.equals('')">
	AND WR_DATE BETWEEN #{startDate} AND #{endDate}
	</if>
	ORDER BY NT_NO)
	<![CDATA[
	WHERE RN > (#{page}-1) * 10
		AND RN <= #{page} * 10
	]]>
	</select>
</mapper>