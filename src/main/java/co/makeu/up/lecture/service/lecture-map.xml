<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.makeu.up.lecture.service.LectureMapper">
	<insert id="lectureInsert" parameterType="co.makeu.up.lecture.service.LectureVO">
		INSERT INTO LECTURE
		VALUES((SELECT NVL(MAX(LT_NO), 0)+1 FROM LECTURE), #{creId}, #{ttl}, #{intro}, #{upCtgr}, #{downCtgr}, #{thumb}, #{pht1}, #{pht2}, #{pht3}, 
			   #{openTerm}, #{tlsnTerm}, #{prc}, #{kitName}, #{kitIntro}, #{kitPrc}, #{tag1}, #{tag2}, #{tag3}, 
			   SYSDATE, 'L02', (SELECT ADD_MONTHS(SYSDATE, #{openTerm}) FROM DUAL), SYSDATE)
	</insert>
	<select id="lectureSelect" parameterType="Integer" resultType="co.makeu.up.lecture.service.LectureVO">
		SELECT * FROM CNAMELECTURE WHERE LT_NO = #{ltNo}
	</select>
	<select id="requestLecture" parameterType="co.makeu.up.lecture.service.LectureVO" resultType="co.makeu.up.lecture.service.LectureVO">
		SELECT * 
		FROM CNAMELECTURE 
		WHERE CRE_ID = #{creId} AND LT_ST_CODE IN ('L02','L07') 
		ORDER BY LT_NO DESC
	</select>
	<select id="openLecture" parameterType="co.makeu.up.lecture.service.LectureVO" resultType="co.makeu.up.lecture.service.LectureVO">
		SELECT l.*, (select round(avg(star),1) from review r where (l.lt_no = r.lt_no) and rv_code ='RE01') as avgStar,
		(select count(*) from sugang s where l.lt_no = s.lt_no) as studentCount
		FROM CNAMELECTURE l
		WHERE l.CRE_ID = #{creId} AND l.LT_ST_CODE = 'L01'
		ORDER BY l.LT_NO DESC
	</select>
	<select id="closeLecture" parameterType="co.makeu.up.lecture.service.LectureVO" resultType="co.makeu.up.lecture.service.LectureVO">
		SELECT l.*, (select round(avg(star),1) from review r where (l.lt_no = r.lt_no) and rv_code ='RE01') as avgStar,
		(select count(*) from sugang s where l.lt_no = s.lt_no) as studentCount
		FROM CNAMELECTURE l
		WHERE l.CRE_ID = #{creId} AND l.LT_ST_CODE = 'L03'
		ORDER BY l.LT_NO DESC
	</select>
	<select id="reportLecture" parameterType="co.makeu.up.lecture.service.LectureVO" resultType="co.makeu.up.lecture.service.LectureVO">
		SELECT l.*, (select round(avg(star),1) from review r where (l.lt_no = r.lt_no) and rv_code ='RE01') as avgStar,
		(select count(*) from sugang s where l.lt_no = s.lt_no) as studentCount
		FROM CNAMELECTURE l
		WHERE l.CRE_ID = #{creId} AND l.LT_ST_CODE IN ('L04','L06')
		ORDER BY l.LT_NO DESC
	</select>
	<update id="lectureUpdate" parameterType="co.makeu.up.lecture.service.LectureVO">
		UPDATE LECTURE SET
		UP_CTGR = #{upCtgr}, DOWN_CTGR = #{downCtgr},
		<if test = "pht1 != null">
			PHT_1 = #{pht1}, 
		</if>
		<if test = "pht2 != null">
			PHT_2 = #{pht2}, 
		</if>
		<if test = "pht3 != null"> 
			PHT_3 = #{pht3},
		</if>
		<if test = "thumb != null">
			THUMB = #{thumb},
		</if>
		TTL = #{ttl}, INTRO = #{intro}, TAG_1 = #{tag1}, TAG_2 = #{tag2}, TAG_3 = #{tag3}
		WHERE LT_NO = #{ltNo}
	</update>
	
</mapper>