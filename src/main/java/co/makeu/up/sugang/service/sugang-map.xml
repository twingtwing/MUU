<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.makeu.up.sugang.service.SugangMapper">
	<select id="sugangSelectList" parameterType="String" resultType="co.makeu.up.sugang.service.SugangVO">
		SELECT S.*, L.TTL, L.THUMB FROM 
		SUGANG S JOIN LECTURE L
		ON S.LT_NO = L.LT_NO 
		WHERE ID = #{id}
		AND TLSN_ST_CODE != 'SU03'
		ORDER BY S.REG_DATE
	</select>
	<select id="sugangCheckDate" parameterType="co.makeu.up.sugang.service.SugangVO" resultType="co.makeu.up.sugang.service.SugangVO">		
		SELECT S.*,L.TTL,L.THUMB FROM SUGANG S JOIN LECTURE L
		ON S.LT_NO = L.LT_NO
		WHERE S.LT_NO=#{ltNo} 
		AND S.ID = #{id} 
		AND S.EXP_DATE>SYSDATE
		AND TLSN_ST_CODE='SU01'
	</select>
	<update id="sugangRefundUpdate" parameterType="Integer">
		UPDATE SUGANG 
		SET TLSN_ST_CODE = 'SU03'
		WHERE TLSN_NO = #{tlsnNo}
	</update>
	<select id="sugangBeforeRefund" resultType="Integer" parameterType="co.makeu.up.sugang.service.SugangVO">
		SELECT COUNT(*) CNT FROM SUGANG
        WHERE ID = #{id}
        AND REG_DATE > SYSDATE-7
        AND TLSN_NO= #{tlsnNo}
	</select>
	<select id="sugangPay" parameterType="co.makeu.up.sugang.service.SugangVO" resultType="co.makeu.up.sugang.service.SugangVO">
		SELECT R.RF_ST_CODE, P.* FROM (SELECT S.*,L.TTL,L.INTRO,L.THUMB,L.KIT_NAME,L.KIT_INTRO,L.KIT_PRC,L.CRE_ID
		FROM SUGANG S JOIN LECTURE L
		ON S.LT_NO = L.LT_NO
		WHERE ID = #{id}
	<if test="regDateSearch != null and expDateSearch != null">
		AND S.REG_DATE <![CDATA[>]]> #{regDateSearch}
        AND S.EXP_DATE <![CDATA[<]]> #{expDateSearch}
	</if>
		ORDER BY S.REG_DATE) P LEFT OUTER JOIN REFUND R
        ON R.TLSN_NO = P.TLSN_NO
	</select>
	
	<update id="updateSugangConfirm" parameterType="co.makeu.up.sugang.service.SugangVO">
		UPDATE SUGANG 
		SET SHIP_ST_CODE = #{shipStCode}
		WHERE TLSN_NO = #{tlsnNo}
	</update>
	
	<select id="userRefundList" parameterType="String" resultType="co.makeu.up.sugang.service.SugangVO">
		SELECT R.*,L.TTL, L.CRE_ID FROM (SELECT R.REQ_DATE,R.CONTENT,R.RF_ST_CODE,S.TLSN_NO,S.PAY,S.LT_NO FROM REFUND R JOIN SUGANG S
		ON R.TLSN_NO = S.TLSN_NO
		WHERE ID = #{id}) R JOIN LECTURE L
		ON R.LT_NO = L.LT_NO
	</select>
	
	<insert id="sugangInsert" parameterType="co.makeu.up.sugang.service.SugangVO">
		INSERT INTO SUGANG(TLSN_NO,ID,LT_NO,REG_DATE,USE_POINT,TLSN_ST_CODE,SHIP_ST_CODE,PAY,ZIP,ADDR,DETA_ADDR,TEL,EXP_DATE)
		VALUES((SELECT NVL(MAX(TLSN_NO), 0)+1 FROM SUGANG),#{id},#{ltNo},SYSDATE,${usePoint},'SU01',#{shipStCode},#{pay},#{zip},#{addr},#{detaAddr},#{tel},ADD_MONTHS(SYSDATE,#{num}))
	</insert>
</mapper>